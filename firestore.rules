rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check ownership
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Helper function to check if user is the site owner
    function isSiteOwner() {
      return request.auth != null && request.auth.uid == 'UoP0OzTFp5RnVclt7XSDDkbzc5W2';
    }

    // Helper function to check ownership of deployed employee
    function isEmployeeOwner(employeeId) {
        return get(/databases/$(database)/documents/deployedEmployees/$(employeeId)).data.userId == request.auth.uid;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Users: Can only read/write their own user document.
    // This allows them to update their own profile information but not others.
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Business Profiles: Users can only create, read, and update their own business profile.
    match /businessProfiles/{userId} {
       allow read, update, create: if isOwner(userId);
    }

    // Deployed Employees: Users can manage their own deployed employees.
    match /deployedEmployees/{employeeId} {
      allow read, write: if request.auth != null && isEmployeeOwner(employeeId);
    }
    
    // Users can create analytics events, but not read or modify them.
    match /user_analytics/{analyticsId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if false;
    }
    
    // Users can create and read their own deployment requests.
    match /deploymentRequests/{requestId} {
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow read: if request.auth != null && resource.data.userId == request.auth.uid;
        allow update, delete: if false;
    }

    // Users can manage their own power-ups.
    match /users/{userId}/powerUps/{powerUpId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // User stats: users can read their own stats, admins manage writes
    match /user_stats/{statId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }

    // Website Integrations: Users can manage their own integrations
    match /websiteIntegrations/{integrationId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read, update: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Platform stats: allow authenticated reads and admin writes
    match /platform_stats/{statId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Stripe customer data is not client-accessible.
    match /customers/{userId} {
        allow read, write: if false;
    }
    
    match /customers/{userId}/subscriptions/{subscriptionId}{
      allow read, write: if false;
    }

    // AI Employees: all authenticated users can read all
    match /ai_employees/{employeeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // AI employee templates: all authenticated users can read
    match /ai_employee_templates/{templateId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Team communications: users can only manage their own.
    match /ai_team_communications/{communicationId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Agent metrics: users can only manage their own.
    match /agent_metrics/{metricId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Requests: users can only manage their own.
    match /requests/{requestId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Agent tasks: users can only manage their own.
    match /agent_tasks/{taskId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Checkout sessions: server writes only
    match /checkout_sessions/{sessionId} {
      allow read, write: if false;
    }

    // AI Team Executions: users can only manage their own.
    match /ai_team_executions/{executionId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Business Goals: users can only manage their own.
    match /business_goals/{goalId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // AI Shared Knowledge: users can only manage their own.
    match /ai_shared_knowledge/{knowledgeId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Puter Script Requests: authenticated users can create/read their own
    match /puter-script-requests/{requestId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // Rate Limits: server-managed only
    match /_rate_limits/{limitId} {
      allow read, write: if false;
    }

    // Site owner has unrestricted access to all documents
    match /{document=**} {
      allow read, write: if isSiteOwner();
    }

    // DEFAULT DENY: Must be at the END so specific rules above take precedence
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
