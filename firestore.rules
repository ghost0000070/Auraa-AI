
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check ownership
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check ownership of deployed employee
    function isEmployeeOwner(employeeId) {
        return get(/databases/$(database)/documents/deployedEmployees/$(employeeId)).data.userId == request.auth.uid;
    }

    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }

    // Users: Can only read/write their own user document.
    // This allows them to update their own profile information but not others.
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

<<<<<<< HEAD
    // Business Profiles: Users can only create, read, and update their own business profile.
    match /businessProfiles/{userId} {
       allow read, update, create: if isOwner(userId);
    }

    // Deployed Employees: Users can manage their own deployed employees.
    match /deployedEmployees/{employeeId} {
      allow read, write: if request.auth != null && isEmployeeOwner(employeeId);
    }
    
    // Users can create analytics events, but not read or modify them.
    match /user_analytics/{analyticsId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if false;
    }
    
    // Users can create and read their own deployment requests.
    match /deploymentRequests/{requestId} {
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow read: if request.auth != null && resource.data.userId == request.auth.uid;
        allow update, delete: if false;
    }

    // Users can manage their own power-ups.
=======
    // User Stats: Users can read their own stats
    match /user_stats/{statId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if isAdmin();
    }

    // Power-Ups: Users can manage their own power-ups
>>>>>>> ca48bc68e (feat: refresh AI employee templates and deploy)
    match /users/{userId}/powerUps/{powerUpId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
    }

<<<<<<< HEAD
    // Platform stats are not client-accessible.
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {

        // Helper function to check ownership
        function isOwner(userId) {
          return request.auth.uid == userId;
        }

        // Helper function to check ownership of deployed employee
        function isEmployeeOwner(employeeId) {
            return get(/databases/$(database)/documents/deployedEmployees/$(employeeId)).data.userId == request.auth.uid;
        }

        function isAdmin() {
          return request.auth != null && request.auth.token.admin == true;
        }

        // Default deny all access
        match /{document=**} {
          allow read, write: if false;
        }

        // Users: Can only read/write their own user document.
        // This allows them to update their own profile information but not others.
        match /users/{userId} {
          allow read, write: if isOwner(userId);
        }

        // Business Profiles: Users can only create, read, and update their own business profile.
        match /businessProfiles/{userId} {
           allow read, update, create: if isOwner(userId);
        }

        // Deployed Employees: Users can manage their own deployed employees.
        match /deployedEmployees/{employeeId} {
          allow read, write: if request.auth != null && isEmployeeOwner(employeeId);
        }
    
        // Users can create analytics events, but not read or modify them.
        match /user_analytics/{analyticsId} {
          allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
          allow read, update, delete: if false;
        }
    
        // Users can create and read their own deployment requests.
        match /deploymentRequests/{requestId} {
            allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
            allow read: if request.auth != null && resource.data.userId == request.auth.uid;
            allow update, delete: if false;
        }

        // Users can manage their own power-ups.
        match /users/{userId}/powerUps/{powerUpId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // User stats: users can read their own stats, admins manage writes
        match /user_stats/{statId} {
          allow read: if request.auth != null && resource.data.userId == request.auth.uid;
          allow write: if isAdmin();
        }

        // Website Integrations: Users can manage their own integrations
        match /websiteIntegrations/{integrationId} {
          allow create: if request.auth.uid == request.resource.data.userId;
          allow read, update: if request.auth.uid == resource.data.userId;
        }

        // Platform stats: allow authenticated reads and admin writes
        match /platform_stats/{statId} {
          allow read: if request.auth != null;
          allow write: if isAdmin();
        }

        // Stripe customer data is not client-accessible.
        match /customers/{userId} {
            allow read, write: if false;
        }
    
        match /customers/{userId}/subscriptions/{subscriptionId}{
          allow read, write: if false;
        }

        // Allow read access to aiEmployees for authenticated users
        match /aiEmployees/{employeeId} {
          allow read: if request.auth != null;
        }

        // TEMPORARY: Allow read/write access to ai_employee_templates for everyone to populate data
        match /ai_employee_templates/{templateId} {
          allow read, write: if true;
        }

        // Allow read and write access to ai_team_communications for authenticated users
        match /ai_team_communications/{communicationId} {
          allow read, write: if request.auth != null;
        }

        // Allow read access to agent_metrics for authenticated users
        match /agent_metrics/{metricId} {
          allow read: if request.auth != null;
        }

        // Users can create requests, but not read, update, or delete them. (keeping for backward compatibility if needed)
        match /requests/{requestId} {
            allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
            allow read, update, delete: if false;
        }

        // Allow read and write access to agent_tasks for authenticated users
        match /agent_tasks/{taskId} {
          allow read, write: if request.auth != null;
        }
      }
    }
